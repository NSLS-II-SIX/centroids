<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Second Pass Through Photons &#8212; centroids v0.1.11-1-g87c4e6f documentation</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Centroids API" href="api.html" />
    <link rel="prev" title="Initial Pass Through Image" href="first_pass.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          centroids</a>
        <span class="navbar-text navbar-version pull-left"><b>v0.1.11-1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="theory.html">Theory of Operation</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="theory.html#contents">Contents</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="first_pass.html">Initial Pass Through Image</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Second Pass Through Photons</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="theory.html#introduction">Introduction</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Centroids API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#python-api">Python API</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#initialization-functions">Initialization Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#data-processing-functions">Data Processing Functions</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Second Pass Through Photons</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="first_pass.html" title="Previous Chapter: Initial Pass Through Image"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Initial Pass ...</span>
    </a>
  </li>
  <li>
    <a href="api.html" title="Next Chapter: Centroids API"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Centroids API &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="_sources/second_pass.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="second-pass-through-photons">
<h1>Second Pass Through Photons<a class="headerlink" href="#second-pass-through-photons" title="Permalink to this headline">¶</a></h1>
<p>Once potential photon events have been located, the centroiding algorithm
processes the list of potential events. If an event is determined to be a
photon, then the resultant parameters are calculated and added to a list of
detected photons. The flow of this algorithm is shown in
<a class="reference internal" href="#second-pass-digraph"><span class="std std-ref">this flowchart</span></a>.</p>
<p>The algorithm starts by assessing what the potential photon’s overlap with
other events is. This is done using the overlap image calculated in the
firstpass. Here if the sum of the <span class="math notranslate nohighlight">\(n \times n\)</span> cluster is calculated.
If the sum is equal to the cluster size, then the photon event is isolated.
If the value is greater than that of the cluster size, then the photon event
overlaps another event. If this value is greater than the value specified in
the parameters (<code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">overlap_max</span></code>), then the event is rejected.</p>
<p>Next, the pixel intensities in the <span class="math notranslate nohighlight">\(n \times n\)</span> box are sorted, highest
first via a <a class="reference external" href="https://en.wikipedia.org/wiki/Bubble_sort">bubble sort</a> . The
background value is calculated by averaging the last
<code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">pixel_photon_bgnd</span></code> values in the sorted list. The integrated
intensity of the photon is then calculated by summing up the first
<code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">pixel_photon_num</span></code> values is the sorted list after subtracting the
average background value just calculated. The photon event is then filtered
using the integrated intensity by the <code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">sum_min</span></code> and
<code class="xref cpp cpp-var docutils literal notranslate"><span class="pre">sum_max</span></code>.</p>
<p>After calculating the integrated intensity, the <em>center of mass</em> of the
photon event is calculated using the equations:</p>
<div class="math notranslate nohighlight">
\[C_x = \frac{\sum_i I_i x_i}{\sum_i I_i}
\quad\text{and}\quad
C_y = \frac{\sum_i I_i y_i}{\sum_i I_i}\]</div>
<p>where <span class="math notranslate nohighlight">\(I_x\)</span> and <span class="math notranslate nohighlight">\(I_y\)</span> are the intensity of the background
corrected pixel intensities, <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> are the fractional
pixel coordinates and the sum index <span class="math notranslate nohighlight">\(i\)</span> is over all the pixels in the
cluster.</p>
<p>The pixel cluster is then fitted using a least squares algorithm in both 2D
and 1D. The pixel cluster is fitted to the <em>error function</em> being the
integral of a <em>gaussian function</em>. In 2D this function is:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\DeclareMathOperator\erf{erf}\\I = B + I_0 \left(
\erf \frac{\left( x - \frac{1}{2} - x_0 \right)}{\sqrt{2} \sigma} -
\erf \frac{\left( x + \frac{1}{2} - x_0 \right)}{\sqrt{2} \sigma}
\right)\cdot\left(
\erf \frac{\left( y - \frac{1}{2} - y_0 \right)}{\sqrt{2} \sigma} -
\erf \frac{\left( y + \frac{1}{2} - y_0 \right)}{\sqrt{2} \sigma}
\right)\end{aligned}\end{align} \]</div>
<p>With the 1D version being:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\DeclareMathOperator\erf{erf}\\I = B + I_0 \left(
\erf \frac{\left( x - \frac{1}{2} - x_0 \right)}{\sqrt{2} \sigma} -
\erf \frac{\left( x + \frac{1}{2} - x_0 \right)}{\sqrt{2} \sigma}
\right)\end{aligned}\end{align} \]</div>
<p>where <span class="math notranslate nohighlight">\(I\)</span> is the intensity at pixel <span class="math notranslate nohighlight">\(x\)</span> (or <span class="math notranslate nohighlight">\(x,y\)</span> in 2D),
<span class="math notranslate nohighlight">\(B\)</span> is the background and <span class="math notranslate nohighlight">\(x_0\)</span> and <span class="math notranslate nohighlight">\(y_0\)</span> are the center
coordinates of the gaussian.</p>
<p>The fit parameters <span class="math notranslate nohighlight">\(\sigma\)</span> and <span class="math notranslate nohighlight">\(x\)</span> (or <span class="math notranslate nohighlight">\(x,y\)</span> in 2D), can be
constrained by passing their constrains to the photon finding routine. These
constraints are implemented in the least squares fitting using the <span class="math notranslate nohighlight">\(\tanh\)</span>
function, of the form:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\DeclareMathOperator\tanh{tanh}\\p = m + r \tanh p_f\end{aligned}\end{align} \]</div>
<p>where <span class="math notranslate nohighlight">\(p_f\)</span> is the parameter in the least squares fit, <span class="math notranslate nohighlight">\(p\)</span> is
the parameter in the fitting function, <span class="math notranslate nohighlight">\(m\)</span> is the mean of the fitting
parameter range and <span class="math notranslate nohighlight">\(r\)</span> is the range. This results in the fitting
parameter being constrained in the range <span class="math notranslate nohighlight">\((m - r) &lt; p &lt; (m + r)\)</span>.</p>
<p>The results of the fit are stored in the output table of photon parameters.
The individual parameters are stored along with the computed error,
calculated as the square root of the diagonal of the covarience matrix.</p>
<p>The standard error on the fit is also calculated, given a suitable fit. The
standard error is computed by comparing the actual data with the model:</p>
<div class="math notranslate nohighlight">
\[\mathrm{Std\,Err} = \sqrt{\frac{\sum_N \left( m - d \right)^2}{N}}\]</div>
<p>where <span class="math notranslate nohighlight">\(N\)</span> is the number of data points used in the fit, <span class="math notranslate nohighlight">\(m\)</span>
is the model value and <span class="math notranslate nohighlight">\(d\)</span> is the (experimentally) measured value.</p>
<div class="figure align-default" id="id1">
<span id="second-pass-digraph"></span><div class="graphviz"><img src="_images/graphviz-de96212482487173ed3b70b5697a2690d4238f53.png" alt="digraph second_pass {
 node[shape=&quot;box&quot;, style=rounded]
    start; end;
 node[shape=&quot;diamond&quot;, style=&quot;&quot;]
    is_last_event[label=&quot;is the last event?&quot;]
    is_overlap_ok[label=&quot;is the event overlapping\nmore than specified?&quot;]
    is_int_ok[label=&quot;is the integral\nwithin bounds?&quot;]
 node[shape=&quot;parallelogram&quot;, style=&quot;&quot;]
    calc_overlap[label=&quot;calculate overlap&quot;]
    sort_pixels[label=&quot;sort pixels by intensity\nin event nxn box&quot;]
    calc_bgnd[label=&quot;calculate background&quot;]
    calc_int[label=&quot;calculate integral&quot;]
    calc_com[label=&quot;calculate com&quot;]
    calc_2d[label=&quot;calculate 2D fit&quot;]
    calc_1d[label=&quot;calculate 1D fits&quot;]
    store[label=&quot;store values in photon table&quot;]
 node[shape=&quot;box&quot;, style=&quot;&quot;]
    set_start_event[label=&quot;move to first event in list&quot;]
    move_to_next_event[label=&quot;move to next event&quot;]

 start -&gt; set_start_event
 set_start_event -&gt; calc_overlap
 calc_overlap -&gt; is_overlap_ok
 is_overlap_ok -&gt; is_last_event[label=&quot;&gt; overlap_max&quot;]
 is_overlap_ok -&gt; sort_pixels[label=&quot;&lt; overlap_max&quot;]
 sort_pixels -&gt; calc_bgnd
 calc_bgnd -&gt; calc_int
 calc_int -&gt; is_int_ok
 is_int_ok -&gt; is_last_event[label=&quot;out of bounds&quot;]
 is_int_ok -&gt; calc_com[label=&quot;sum_min &lt; int &lt; sum_max&quot;]
 calc_com -&gt; calc_2d
 calc_2d -&gt; calc_1d
 calc_1d -&gt; store
 store -&gt; is_last_event

 is_last_event -&gt; end[label=&quot;yes&quot;]
 is_last_event -&gt; move_to_next_event[label=&quot;no&quot;]
 move_to_next_event -&gt; calc_overlap
}" class="graphviz" /></div>
<p class="caption"><span class="caption-text">Second pass through events found in first pass</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Stuart B. Wilkins.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.1.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>